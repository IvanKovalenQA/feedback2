<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Анкета специалиста</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * { box-sizing: border-box; }

    body{
      margin:0; padding:0; min-height:100vh;
      display:flex; align-items:center; justify-content:center;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: url("https://raw.githubusercontent.com/IvanKovalenQA/feedback2/main/pick.jpg") no-repeat center center fixed;
      background-size: cover;
    }

    .card{
      width:100%;
      max-width: 860px;
      background: rgba(255,255,255,0.94);
      border-radius: 18px;
      padding: 22px 22px 26px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.35);
      backdrop-filter: blur(6px);
    }

    @media (min-width: 768px){
      .card { padding: 26px 32px 32px; }
    }

    h1{ margin:0 0 6px; text-align:center; font-size:1.7rem; }
    .subtitle{ text-align:center; opacity:.8; margin:0 0 18px; }

    .progress-wrap{ margin-bottom: 16px; }
    .progress-top{ display:flex; justify-content:space-between; font-size:.85rem; opacity:.8; margin-bottom:6px; }
    .bar{ height:7px; background:#e5e5e5; border-radius:999px; overflow:hidden; }
    .bar > div{ height:100%; width:0%; background:#000; transition:width .25s ease; }

    .step{ display:none; animation:fade .2s ease; }
    .step.active{ display:block; }
    @keyframes fade{ from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:none} }

    .step-title{ font-weight:700; font-size:1.15rem; margin: 6px 0 8px; }
    .step-desc{ opacity:.8; margin:0 0 14px; }

    .grid2{ display:grid; gap: 10px 18px; }
    @media (min-width:768px){ .grid2{ grid-template-columns: 1fr 1fr; } }

    label{ display:block; font-weight:600; margin:0 0 5px; }
    .hint{ font-size:.85rem; opacity:.75; margin:-2px 0 6px; }

    input[type="text"], input[type="tel"], input[type="number"], textarea{
      width:100%;
      padding: 9px 11px;
      border-radius: 10px;
      border:1px solid #d4d4d4;
      background:#fafafa;
      outline:none;
      font:inherit;
    }
    textarea{ min-height:72px; resize:vertical; }
    input:focus, textarea:focus{ border-color:#000; background:#fff; }

    .row{ margin-bottom: 14px; }

    .radio-row{
      display:flex; flex-wrap:wrap; gap: 10px 16px;
      margin: 4px 0 0;
    }
    .radio-row label{ font-weight:400; display:flex; gap:8px; align-items:center; cursor:pointer; }

    .hidden{ display:none !important; }

    .nav{
      margin-top: 18px;
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    button{
      border:0; border-radius:999px;
      padding: 10px 22px;
      font:inherit; font-weight:700;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
      display:inline-flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    button:hover{ transform: translateY(-1px); box-shadow: 0 6px 14px rgba(0,0,0,0.16); }
    button:disabled{ opacity:.55; cursor:default; transform:none; box-shadow:none; }

    .btn-secondary{ background:#f1f1f1; color:#111; }
    .btn-primary{ background:#000; color:#fff; }

    .ok{
      margin-top: 12px;
      padding: 12px 14px;
      background:#e7fbe7;
      border:1px solid #86d986;
      border-radius: 12px;
      font-weight:600;
    }

    /* --- Креатив --- */
    .creative-grid{
      display:grid;
      gap: 12px;
    }
    @media (min-width: 768px){
      .creative-grid{ grid-template-columns: repeat(3, 1fr); }
    }

    .creative-card{
      border: 1px solid #e1e1e1;
      border-radius: 14px;
      overflow:hidden;
      background:#fff;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      display:flex;
      flex-direction:column;
      min-height: 280px;
    }
    .creative-card:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.12);
      border-color:#bdbdbd;
    }
    .creative-media{
      width:100%;
      height: 180px;
      background:#f6f6f6;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .creative-media img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .creative-body{
      padding: 10px 12px 12px;
      display:flex;
      flex-direction:column;
      gap: 6px;
      flex:1;
    }
    .creative-title{ font-weight:800; }
    .creative-text{ opacity:.78; font-size:.9rem; line-height:1.25; }
    .creative-footer{
      padding: 10px 12px 12px;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .pill{
      display:inline-flex;
      border:1px solid #d8d8d8;
      border-radius:999px;
      padding: 6px 10px;
      font-size:.85rem;
      background:#fafafa;
      gap:8px;
      align-items:center;
    }
    .selected{
      outline: 2px solid #000;
      outline-offset: 2px;
    }

    .error{
      margin-top: 10px;
      padding: 10px 12px;
      background:#fff0f0;
      border:1px solid #ffb4b4;
      border-radius: 12px;
      font-weight:600;
      color:#5a0000;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>Анкета специалиста</h1>
    <p class="subtitle">Заполните все поля — это нужно, чтобы собрать сильный профиль и записать данные в таблицу.</p>

    <div class="progress-wrap">
      <div class="progress-top">
        <span id="progressText">Шаг 1 из 4</span>
        <span id="progressTitle">Контакты</span>
      </div>
      <div class="bar"><div id="progressFill"></div></div>
    </div>

    <form id="form">
      <!-- STEP 1 -->
      <section class="step active" data-title="Контакты">
        <div class="step-title">Контакты и базовая информация</div>
        <p class="step-desc">Все поля обязательные.</p>

        <div class="grid2">
          <div class="row">
            <label>Имя и фамилия *</label>
            <input type="text" name="name" required />
          </div>

          <div class="row">
            <label>Номер телефона *</label>
            <div class="hint">Можно в любом формате: +7..., +380..., 0...</div>
            <input type="tel" name="phone" required />
          </div>
        </div>

        <div class="row">
          <label>Ссылки на соцсети *</label>
          <div class="hint">Через запятую: Instagram, Telegram, сайт и т.д.</div>
          <textarea name="socials" required></textarea>
        </div>

        <div class="row">
          <label>Какую услугу предоставляете? *</label>
          <input type="text" name="service" required />
        </div>
      </section>

      <!-- STEP 2 -->
      <section class="step" data-title="Практика">
        <div class="step-title">Суть вашей практики</div>
        <p class="step-desc">Опишите конкретику — это ляжет в основу креативов.</p>

        <div class="row">
          <label>Какие конкретные проблемы вы помогаете решать? *</label>
          <textarea name="problems" required></textarea>
        </div>

        <div class="row">
          <label>Как ваша практика помогает исправить жизнь к лучшему? *</label>
          <textarea name="practice_help" required></textarea>
        </div>

        <div class="grid2">
          <div class="row">
            <label>Сколько лет вы занимаетесь этой практикой? *</label>
            <input type="number" name="experience" min="0" step="1" required />
          </div>

          <div class="row">
            <label>Какому количеству людей вы помогли до сих пор? *</label>
            <input type="number" name="people_count" min="0" step="1" required />
          </div>
        </div>
      </section>

      <!-- STEP 3 -->
      <section class="step" data-title="Аудитория">
        <div class="step-title">Аудитория и уникальность</div>
        <p class="step-desc">Тоже всё обязательное. Для “Да, есть ограничения” появится поле — оно станет обязательным автоматически.</p>

        <div class="row">
          <label>Есть ли возраст, с которым вы не работаете? *</label>
          <div class="radio-row">
            <label><input type="radio" name="age_limit_choice" value="нет" required /> Нет, работаю со всеми</label>
            <label><input type="radio" name="age_limit_choice" value="есть" required /> Да, есть ограничения</label>
          </div>

          <div id="ageDetails" class="row hidden" style="margin-top:10px;">
            <label>Уточните возрастные ограничения *</label>
            <textarea name="age_limit" id="age_limit" required></textarea>
          </div>
        </div>

        <div class="row">
          <label>Есть ли ограничения по полу клиентов? *</label>
          <div class="radio-row">
            <label><input type="radio" name="gender_limit_choice" value="нет" required /> Нет</label>
            <label><input type="radio" name="gender_limit_choice" value="женщины" required /> Только женщины</label>
            <label><input type="radio" name="gender_limit_choice" value="мужчины" required /> Только мужчины</label>
            <label><input type="radio" name="gender_limit_choice" value="другое" required /> Другое / уточнить</label>
          </div>

          <div id="genderDetails" class="row hidden" style="margin-top:10px;">
            <label>Уточните ограничения по полу *</label>
            <textarea name="gender_limit" id="gender_limit" required></textarea>
          </div>
        </div>

        <div class="row">
          <label>Опишите “идеального клиента” *</label>
          <textarea name="ideal_client" required></textarea>
        </div>

        <div class="row">
          <label>Чем вы отличаетесь от других специалистов? *</label>
          <textarea name="difference" required></textarea>
        </div>

        <div class="row">
          <label>В каком формате вы работаете с клиентами? *</label>
          <textarea name="format" required></textarea>
        </div>
      </section>

      <!-- STEP 4 -->
      <section class="step" data-title="Креатив">
        <div class="step-title">Составление рекламного креатива</div>
        <p class="step-desc">Выберите один тип креатива. В таблицу запишется только его название.</p>

        <!-- это скрытое поле — именно оно уйдет в таблицу -->
        <input type="hidden" name="creative_type" id="creative_type" required />

        <div class="creative-grid" id="creativeGrid">
          <div class="creative-card" data-value="Интервью">
            <div class="creative-media">
              <img src="./interview.gif" alt="Интервью" />
            </div>
            <div class="creative-body">
              <div class="creative-title">Интервью</div>
              <div class="creative-text">Структурные вопросы → экспертные ответы. Подходит, если важно “раскрыть специалиста”.</div>
            </div>
            <div class="creative-footer">
              <span class="pill"><input type="radio" name="creative_pick" /> Выбрать</span>
            </div>
          </div>

          <div class="creative-card" data-value="Говорящая голова">
            <div class="creative-media">
              <img src="./talking-head.gif" alt="Говорящая голова" />
            </div>
            <div class="creative-body">
              <div class="creative-title">Говорящая голова</div>
              <div class="creative-text">Короткие сильные тезисы в кадре. Подходит для “быстрого” прогрева и доверия.</div>
            </div>
            <div class="creative-footer">
              <span class="pill"><input type="radio" name="creative_pick" /> Выбрать</span>
            </div>
          </div>

          <div class="creative-card" data-value="История-клиента">
            <div class="creative-media">
              <img src="./client-story.gif" alt="История клиента" />
            </div>
            <div class="creative-body">
              <div class="creative-title">История-клиента</div>
              <div class="creative-text">Проблема → путь → результат. Подходит, если есть реальные кейсы и хочется “вовлечь”.</div>
            </div>
            <div class="creative-footer">
              <span class="pill"><input type="radio" name="creative_pick" /> Выбрать</span>
            </div>
          </div>
        </div>

        <div id="creativeError" class="error hidden">
          Выберите один тип креатива, чтобы продолжить.
        </div>

        <div id="ok" class="ok hidden">
          Спасибо! Ваши ответы сохранены в Google Sheets.
        </div>

        <div id="serverError" class="error hidden"></div>
      </section>

      <div class="nav">
        <button type="button" id="prevBtn" class="btn-secondary" disabled>← Назад</button>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button type="button" id="nextBtn" class="btn-primary">Далее →</button>
          <button type="submit" id="submitBtn" class="btn-primary hidden">Завершить</button>
        </div>
      </div>
    </form>
  </div>

  <script>
    (function(){
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyOEsnVXC4KDZuBLmAGxSRJ5k34a-HLtmLpif6VZguMNwNiYWAniZ0wsCk-cXMMGhwfdQ/exec";

      const form = document.getElementById('form');
      const steps = Array.from(document.querySelectorAll('.step'));
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const submitBtn = document.getElementById('submitBtn');

      const progressText = document.getElementById('progressText');
      const progressTitle = document.getElementById('progressTitle');
      const progressFill = document.getElementById('progressFill');

      const ageDetails = document.getElementById('ageDetails');
      const ageLimit = document.getElementById('age_limit');

      const genderDetails = document.getElementById('genderDetails');
      const genderLimit = document.getElementById('gender_limit');

      const creativeType = document.getElementById('creative_type');
      const creativeGrid = document.getElementById('creativeGrid');
      const creativeError = document.getElementById('creativeError');

      const ok = document.getElementById('ok');
      const serverError = document.getElementById('serverError');

      let stepIndex = 0;

      function setProgress(){
        const total = steps.length;
        const current = stepIndex + 1;
        progressText.textContent = `Шаг ${current} из ${total}`;
        progressTitle.textContent = steps[stepIndex].dataset.title || '';
        progressFill.style.width = (current / total) * 100 + '%';
      }

      function showStep(i){
        steps.forEach((s, idx) => s.classList.toggle('active', idx === i));
        stepIndex = i;

        prevBtn.disabled = stepIndex === 0;

        const isLast = stepIndex === steps.length - 1;
        nextBtn.classList.toggle('hidden', isLast);
        submitBtn.classList.toggle('hidden', !isLast);

        setProgress();
      }

      function validateCurrentStep(){
        // Проверяем required внутри текущего шага
        const currentStep = steps[stepIndex];

        // Спец-проверка для шага "Креатив": creative_type обязателен
        if (currentStep.dataset.title === 'Креатив') {
          if (!creativeType.value || creativeType.value.trim() === '') {
            creativeError.classList.remove('hidden');
            return false;
          }
          creativeError.classList.add('hidden');
        }

        const required = Array.from(currentStep.querySelectorAll('[required]'));
        for (const el of required) {
          // пропускаем скрытые условные поля (которые hidden) — но мы ниже управляем required корректно
          if (el.offsetParent === null) continue;

          if (el.type === 'radio') {
            const group = currentStep.querySelectorAll(`input[type="radio"][name="${el.name}"]`);
            const checked = Array.from(group).some(r => r.checked);
            if (!checked) {
              group[0].scrollIntoView({behavior:'smooth', block:'center'});
              return false;
            }
          } else {
            if (!String(el.value || '').trim()) {
              el.focus();
              el.scrollIntoView({behavior:'smooth', block:'center'});
              return false;
            }
          }
        }
        return true;
      }

      // --- Условная обязательность ---
      function syncConditionalRequired(){
        const ageChoice = form.querySelector('input[name="age_limit_choice"]:checked')?.value;
        if (ageChoice === 'есть') {
          ageDetails.classList.remove('hidden');
          ageLimit.required = true;
        } else {
          ageDetails.classList.add('hidden');
          ageLimit.required = false;
          ageLimit.value = '';
        }

        const genderChoice = form.querySelector('input[name="gender_limit_choice"]:checked')?.value;
        if (genderChoice === 'другое') {
          genderDetails.classList.remove('hidden');
          genderLimit.required = true;
        } else {
          genderDetails.classList.add('hidden');
          genderLimit.required = false;
          genderLimit.value = '';
        }
      }

      form.addEventListener('change', (e) => {
        if (e.target.name === 'age_limit_choice' || e.target.name === 'gender_limit_choice') {
          syncConditionalRequired();
        }
      });

      // --- Креатив: выбор карточки ---
      creativeGrid.addEventListener('click', (e) => {
        const card = e.target.closest('.creative-card');
        if (!card) return;

        const value = card.dataset.value;

        // set hidden value (это уедет в таблицу)
        creativeType.value = value;

        // UI select
        document.querySelectorAll('.creative-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');

        // radio-метка внутри для красоты
        document.querySelectorAll('.creative-card input[type="radio"][name="creative_pick"]').forEach(r => r.checked = false);
        const radio = card.querySelector('input[type="radio"][name="creative_pick"]');
        if (radio) radio.checked = true;

        creativeError.classList.add('hidden');
      });

      // --- Навигация ---
      prevBtn.addEventListener('click', () => {
        if (stepIndex > 0) showStep(stepIndex - 1);
      });

      nextBtn.addEventListener('click', () => {
        syncConditionalRequired();
        if (!validateCurrentStep()) return;
        if (stepIndex < steps.length - 1) showStep(stepIndex + 1);
      });

      // --- Submit ---
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        syncConditionalRequired();

        // Проверяем текущий шаг (креатив)
        if (!validateCurrentStep()) return;

        // Доп. гарантия: проверим все required по всей форме перед отправкой
        const allRequired = Array.from(form.querySelectorAll('[required]')).filter(el => el.offsetParent !== null);
        for (const el of allRequired) {
          if (el.type !== 'radio' && !String(el.value || '').trim()) {
            el.focus();
            return;
          }
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Отправка...';
        serverError.classList.add('hidden');
        ok.classList.add('hidden');

        try {
          const resp = await fetch(SCRIPT_URL, { method:'POST', body: new FormData(form) });

          let json = null;
          try { json = await resp.json(); } catch(_) {}

          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          if (!json || json.status !== 'success') {
            throw new Error((json && json.message) ? json.message : 'Unknown error');
          }

          ok.classList.remove('hidden');
          ok.scrollIntoView({behavior:'smooth', block:'start'});

          // Можно заблокировать форму после успеха:
          Array.from(form.elements).forEach(el => el.disabled = true);

        } catch (err) {
          serverError.textContent =
            'Не удалось отправить данные. Проверь, что Web App обновлён на новую версию (Deploy → Manage deployments → New version).\n' +
            'Ошибка: ' + String(err);
          serverError.classList.remove('hidden');
          serverError.scrollIntoView({behavior:'smooth', block:'start'});
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Завершить';
        }
      });

      // init
      syncConditionalRequired();
      showStep(0);
    })();
  </script>
</body>
</html>
